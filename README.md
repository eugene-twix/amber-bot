# Amber Bot

Amber Bot — это Telegram-бот, предназначенный для учета и управления командами, участниками и результатами в рамках квизов, настольных игр или любых других турниров. Он помогает организаторам легко создавать события и команды, а участникам — отслеживать свои достижения.

## Стек технологий

- **Язык:** Go
- **База данных:** PostgreSQL
- **Кеш:** Dragonfly
- **ORM:** Bun
- **Развертывание:** Docker

---

## Возможности

Бот поддерживает три уровня доступа: `Viewer` (Пользователь), `Organizer` (Организатор) и `Admin` (Администратор).

### Для всех пользователей
- **Просмотр команд**: Возможность просматривать список всех созданных команд и их подробную информацию (состав, история игр).
- **Просмотр рейтинга**: Доступ к общему рейтингу команд, основанному на их результатах в турнирах.

### Для Организаторов
- **Создание команд**: Управление командами, включая их создание и добавление участников.
- **Создание турниров**: Быстрое создание новых турнирных событий с указанием названия, даты и места проведения.
- **Запись результатов**: Внесение результатов команд в конкретных турнирах.

### Для Администраторов
- **Управление ролями**: Назначение ролей (`Viewer`, `Organizer`, `Admin`) другим пользователям.

---

## Схема БД и связи

**Таблицы:**
- `users` — пользователи Telegram (ключ: `telegram_id`).
- `teams` — команды (`id`, `name`, `created_by`).
- `members` — участники команд (`team_id`, `joined_at`).
- `tournaments` — турниры (`name`, `date`, `location`, `created_by`).
- `results` — результаты (`team_id`, `tournament_id`, `place`, `recorded_by`, `recorded_at`).

**Связи (стрелочная схема):**

```
users.telegram_id
  ↑ (логическая связь, без FK)
teams.created_by
  ↑ (логическая связь, без FK)
tournaments.created_by
  ↑ (логическая связь, без FK)
results.recorded_by

teams.id
  ↑ (FK, ON DELETE CASCADE)
members.team_id

teams.id
  ↑ (FK, ON DELETE CASCADE)
results.team_id

tournaments.id
  ↑ (FK, ON DELETE CASCADE)
results.tournament_id
```

---

## Структура репозитория

```
.
├── cmd/
│   └── bot/
│       └── main.go
├── internal/
│   ├── bot/
│   ├── cache/
│   ├── config/
│   ├── domain/
│   ├── fsm/
│   ├── migrations/
│   └── repository/
│       └── bun/
├── docker-compose.yml
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

---

## Установка и запуск

Для запуска проекта локально следуйте этим шагам.

### 1. Предварительные требования

Убедитесь, что у вас установлены:
- `git`
- `go` (версия 1.24+)
- `docker`
- `docker-compose`
- `age` (для шифрования секретов)

### 2. Клонирование репозитория
```bash
git clone <repository-url>
cd amber-bot
```

### 3. Запуск зависимостей
Запустите базу данных и кеш с помощью Docker:
```bash
make up
```
Эта команда запустит контейнеры с PostgreSQL и Dragonfly в фоновом режиме.

### 4. Управление секретами
Проект использует `age` для шифрования чувствительных данных, таких как токены.

**Если вы настраиваете проект впервые:**
1. Сгенерируйте `age` ключ:
   ```bash
   make secrets-keygen
   ```
   Эта команда создаст файл `.age-key.txt`. **Не добавляйте этот файл в Git.**
2. Скопируйте публичный ключ из вывода команды и добавьте его в файл `.age-recipients`.

**Работа с секретами:**
1. Создайте или отредактируйте файл `.secret.env`. В нем хранятся переменные, которые не должны попасть в Git (например, `TELEGRAM_TOKEN`).
   ```
   TELEGRAM_TOKEN=12345:your-secret-token
   ```
2. Зашифруйте этот файл:
   ```bash
   make secrets-encrypt
   ```
   Эта команда создаст зашифрованный файл `.secret.enc.env`, который можно безопасно коммитить.

Для запуска приложения локально секреты нужно расшифровать. Команда `make run` делает это автоматически.

### 5. Конфигурация
Создайте файл `.env` в корне проекта для несекретных настроек.

```env
# URL для подключения к базе данных из docker-compose
DATABASE_URL=postgres://amber:amber@localhost:5436/amber_bot?sslmode=disable

# URL для подключения к кешу из docker-compose
REDIS_URL=redis://localhost:6379/0

# (Опционально) ID пользователей Telegram, которые получат права администратора при первом запуске
ADMIN_IDS=12345678,87654321
```

### 6. Миграции базы данных
Миграции лежат в `internal/migrations/*.sql` и автоматически применяются при запуске бота (`make run`).

### 7. Запуск бота
Запустите приложение:
```bash
make run
```
Эта команда сначала расшифрует секреты из `.secret.enc.env` в `.secret.env`, а затем запустит бота.

---

## Разработка

Для удобства разработки в `Makefile` есть несколько полезных команд:

- `make up`: Запустить Docker-контейнеры (PostgreSQL, Dragonfly).
- `make down`: Остановить Docker-контейнеры.
- `make run`: Запустить бота с автоматической расшифровкой секретов.
- `make test`: Запустить тесты.
- `make migrate`: Применить миграции БД.
- `make secrets-encrypt`: Зашифровать `.secret.env` в `.secret.enc.env`.
- `make secrets-decrypt`: Расшифровать `.secret.enc.env` в `.secret.env`.
- `make secrets-keygen`: Сгенерировать новый `age` ключ.

## Лицензия

Проект не имеет определенной лицензии. Все права защищены.
